import"./lodash-CyvJ_RrL.js";import{h as Y}from"./moment-zH0z38ay.js";import{_ as _e}from"./BaseCard.vue_vue_type_script_setup_true_lang-CXnM25sU.js";import{_ as ye}from"./BaseTable.vue_vue_type_style_index_0_lang-BdcfvIXs.js";import{_ as we}from"./BaseLoader.vue_vue_type_script_setup_true_lang-DEUrq8Kn.js";import{_ as he}from"./ChartWidget.vue_vue_type_script_setup_true_lang-BR_qrK2z.js";import{_ as Ce}from"./DeleteModal.vue_vue_type_script_setup_true_lang-1BeL1TZf.js";import{_ as ke}from"./BaseBreadcrumb.vue_vue_type_style_index_0_lang-C_OQyfJV.js";import{j}from"./maska-Cp-LWreF.js";import{d as T,u as F,i as z,ay as O,k as r,n as R,o as b,c as S,e as t,w as a,f as _,t as d,b as e,V as y,af as G,aE as J,a as N,ak as Q,ad as Z,ae as Ve,ai as X,an as ee,aF as te,J as ae,al as le,F as oe,p as $,m as B,aC as q,ao as H,as as K,H as xe,av as Ue,Z as $e,q as L,s as P,r as W}from"./index-rKzDa4TW.js";import{u as se,a as Ne}from"./Billing-B3Tg1ihj.js";import{u as Ie}from"./Client-V112gc0S.js";import{u as ie}from"./Rules-DZKrv_I-.js";const De={class:"title text-white"},Ee={class:"tw-mb-1"},Be={class:"tw-mb-1"},Me=T({__name:"NewBillingModal",emits:["update"],setup(I,{emit:s}){const{t:o}=F(),n=se(),V=z(),w=Ie(),{emptyRules:k}=ie(),x=s,h="₽",f=O({mask:`####### ${h}`,reversed:!0,eager:!0}),C=r(!1),u=r(!1),m=r(!1),D=r(!0),v=r({userId:"",valueCents:` ${h}`,currency:"EUR"}),E=R(()=>w.clientList.map(U=>({title:`${U.firstName} ${U.lastName}`,props:{value:U.id}}))),M=async()=>{m.value=!0;try{await n.createInvoice({...v.value,valueCents:Number(v.value.valueCents.replace(` ${h}`,""))*100}),await x("update"),V.createNotification({title:o("notification.materialCreate"),color:"success"}),v.value={userId:"",valueCents:"",currency:"EUR"},C.value=!1}catch{V.createNotification({title:o("notification.errorNotification"),color:"error"})}m.value=!1};return w.getClients({limit:300}).then(()=>{D.value=!1}),(U,i)=>(b(),S(oe,null,[t(y,{onClick:i[0]||(i[0]=g=>C.value=!0),color:"primary",class:"!tw-min-w-full md:!tw-min-w-fit"},{default:a(()=>[_(d(e(o)("billing.newBilling")),1)]),_:1}),t(le,{modelValue:C.value,"onUpdate:modelValue":i[5]||(i[5]=g=>C.value=g),width:"800"},{default:a(()=>[t(G,null,{default:a(()=>[t(J,{class:"pa-4 bg-primary"},{default:a(()=>[N("p",De,d(e(o)("billing.newBilling")),1)]),_:1}),t(Q,null,{default:a(()=>[t(Z,{modelValue:u.value,"onUpdate:modelValue":i[3]||(i[3]=g=>u.value=g),"lazy-validation":""},{default:a(()=>[N("p",Ee,d(e(o)("billing.client")),1),t(Ve,{modelValue:v.value.userId,"onUpdate:modelValue":i[1]||(i[1]=g=>v.value.userId=g),items:E.value,variant:"outlined",clearable:""},null,8,["modelValue","items"]),N("p",Be,d(e(o)("billing.price")),1),X(t(ee,{modelValue:v.value.valueCents,"onUpdate:modelValue":i[2]||(i[2]=g=>v.value.valueCents=g),rules:e(k),variant:"outlined",required:""},null,8,["modelValue","rules"]),[[e(j),void 0,f]])]),_:1},8,["modelValue"])]),_:1}),t(te,null,{default:a(()=>[t(ae),t(y,{onClick:i[4]||(i[4]=g=>C.value=!1),color:"error"},{default:a(()=>[_(d(e(o)("close")),1)]),_:1}),t(y,{onClick:M,loading:m.value,disabled:!u.value,variant:"flat",color:"primary"},{default:a(()=>[_(d(e(o)("add")),1)]),_:1},8,["loading","disabled"])]),_:1})]),_:1})]),_:1},8,["modelValue"])],64))}}),Ae={key:0},Re={key:1,class:"tw-flex tw-flex-col md:tw-block"},Se=T({__name:"StripeLoginButton",setup(I){const{t:s}=F(),o=z(),n=r(!1),V=R(()=>"https://api.mentalcrm.ru"),w=async()=>{n.value=!0,await o.stripeLogout(),n.value=!1};return(k,x)=>e(o).user.type==="Therapist"?(b(),S("div",Ae,[e(o).user.stripeAttached?(b(),S("div",Re,[t(y,{onClick:w,loading:n.value,color:"error",class:"tw-mb-2 md:tw-mb-0 md:tw-mr-2",variant:"flat"},{default:a(()=>[_(d(e(s)("logout")),1)]),_:1},8,["loading"]),t(y,{rel:"noopener noreferrer",href:"https://dashboard.stripe.com/",color:"primary",target:"_blank",variant:"flat",class:"tw-mb-2 md:tw-mb-0"},{default:a(()=>[_(d(e(s)("billing.stripeDashboard")),1)]),_:1})])):(b(),$(y,{key:0,href:`${V.value}/api/therapist/stripe-account`,color:"primary",variant:"flat",class:"tw-mr-2"},{default:a(()=>[_(d(e(s)("billing.loginStripe")),1)]),_:1},8,["href"]))])):B("",!0)}}),Te={class:"title text-white"},Fe=T({__name:"BillingChangeModal",props:q({loading:{default:!1,type:Boolean}},{dialog:{type:Boolean,default:!1},dialogModifiers:{},price:{default:""},priceModifiers:{}}),emits:q(["update"],["update:dialog","update:price"]),setup(I,{emit:s}){const{t:o}=F(),{emptyRules:n}=ie(),V=s,w=H(I,"dialog"),k=H(I,"price"),h=O({mask:"####### ₽",reversed:!0,eager:!0}),f=r(!1);return(C,u)=>(b(),$(le,{modelValue:w.value,"onUpdate:modelValue":u[4]||(u[4]=m=>w.value=m),width:"600"},{default:a(()=>[t(G,null,{default:a(()=>[t(J,{class:"pa-4 bg-primary"},{default:a(()=>[N("p",Te,d(e(o)("materials.addMaterialsForClient")),1)]),_:1}),t(Q,null,{default:a(()=>[t(Z,{"lazy-validation":"",modelValue:f.value,"onUpdate:modelValue":u[1]||(u[1]=m=>f.value=m)},{default:a(()=>[X(t(ee,{modelValue:k.value,"onUpdate:modelValue":u[0]||(u[0]=m=>k.value=m),rules:e(n),label:e(o)("Price"),variant:"outlined",required:""},null,8,["modelValue","rules","label"]),[[e(j),void 0,h]])]),_:1},8,["modelValue"])]),_:1}),t(te,null,{default:a(()=>[t(ae),t(y,{color:"error",onClick:u[2]||(u[2]=m=>w.value=!1)},{default:a(()=>[_(d(e(o)("close")),1)]),_:1}),t(y,{loading:I.loading,disabled:!f.value,variant:"flat",color:"primary",onClick:u[3]||(u[3]=m=>V("update"))},{default:a(()=>[_(d(e(o)("save")),1)]),_:1},8,["loading","disabled"])]),_:1})]),_:1})]),_:1},8,["modelValue"]))}}),Ye=[{title:"Paid",props:{value:"PAID"}},{title:"In Progress",props:{value:"IN_PROGRESS"}},{title:"Unpaid",props:{value:"READY"}},{title:"Failed",props:{value:"FAILED"}}],Le={class:"tw-mb-3 tw-block tw-items-center tw-justify-between md:tw-flex"},Pe={class:"tw-max-w-60 tw-truncate"},We=["href"],ze=10,lt=T({__name:"Billing",setup(I){const{t:s}=F(),o=se(),n=z(),{getStatus:V,getStatusColor:w}=Ne(),k="₽",x=r([]),h=r(""),f=r("WEEK"),C=r(),u=r(!0),m=r(!1),D=r(!1),v=r(!1),E=r(!1),M=r(!1),U=r(1),i=r({id:0,userId:0,therapistId:0,valueCents:0,currency:"",createdAt:"",paidAt:"",userFirstName:"",userLastName:"",therapistFirstName:"",therapistLastName:"",status:"",payoutLink:""}),g=R(()=>[{text:s("billing.name"),value:"name",sortable:!0},{text:s("billing.date"),value:"createdAt",sortable:!0},{text:s("billing.price"),value:"valueCents",sortable:!0},{text:s("billing.status"),value:"status",sortable:!0},{text:s("billing.actions"),value:"actions",sortable:!0,width:170}]),re=R(()=>({series:[{name:s("dashboard.clients"),data:o.chart.map(c=>c.valueCents/100)}]})),ne=R(()=>({chart:{type:"bar",height:350,fontFamily:"inherit",toolbar:{show:!1},animations:{enabled:!1}},colors:[K.colors.primary,K.colors.lightprimary],plotOptions:{bar:{borderRadius:3,borderRadiusWhenStacked:"both",borderRadiusApplication:"start",horizontal:!1,endingShape:"rounded",columnWidth:"20%"}},dataLabels:{enabled:!1},stroke:{show:!0,width:2,colors:["transparent"]},labels:{formatter(c){return c.toFixed(0)}},xaxis:{categories:f.value==="WEEK"?o.chart.map(c=>Y(c.date).format("DD.MM.YYYY")):o.chart.map(c=>Y(c.date).format("DD.MM.YYYY"))},fill:{opacity:1},tooltip:{theme:"dark"},legend:{show:!0,position:"bottom",width:"50px"},responsive:[{breakpoint:600,options:{yaxis:{show:!1}}}]})),ue=c=>{D.value=!0,i.value=c,h.value=`${i.value.valueCents/100} ${k}`},de=c=>{E.value=!0,i.value=c},ce=async()=>{v.value=!0;try{await o.changeInvoice(i.value.id,{valueCents:Number(h.value.replace(` ${k}`,""))*100,currency:i.value.currency}),n.createNotification({title:s("notification.billChange"),color:"success"}),D.value=!1}catch{n.createNotification({title:s("notification.errorNotification"),color:"error"})}v.value=!1},pe=async()=>{M.value=!0;try{await o.deleteInvoice(i.value.id),n.createNotification({title:s("notification.billDelete"),color:"success"}),E.value=!1}catch{n.createNotification({title:s("notification.errorNotification"),color:"error"})}M.value=!1},me=async c=>{await c(),u.value=!1};return n.user.type==="Therapist"&&xe(f,async(c,p)=>{c?(m.value=!0,await o.getBillingChart({period:c}),m.value=!1):p?f.value=p:f.value="WEEK"},{immediate:!0}),Ue(()=>{x.value=[{label:"Status",key:"status",value:null,options:Ye},{label:"Time",key:"time",value:null}]}),(c,p)=>{const fe=W("Receipt2Icon"),ve=W("PencilIcon"),ge=W("TrashIcon");return b(),S(oe,null,[t(ke,{title:"sidebar.billing"}),t(we,{isUpdate:u.value},{default:a(()=>[t(_e,null,{default:a(()=>[N("div",Le,[t(Se),e(n).user.stripeAttached?(b(),$(Me,{key:0,onUpdate:p[0]||(p[0]=l=>C.value?C.value.filter():null)})):B("",!0)]),e(n).user.type==="Therapist"?(b(),$(he,{key:0,toggle:f.value,"onUpdate:toggle":p[1]||(p[1]=l=>f.value=l),isUpdate:u.value,isUpdateWidget:m.value,options:ne.value,series:re.value.series,title:e(s)("dashboard.clients"),class:"tw-mb-5"},null,8,["toggle","isUpdate","isUpdateWidget","options","series","title"])):B("",!0),t(ye,{onUpdate:e(o).getBilling,onCreated:me,page:U.value,"onUpdate:page":p[2]||(p[2]=l=>U.value=l),filters:x.value,"onUpdate:filters":p[3]||(p[3]=l=>x.value=l),total:e(o).total,items:e(o).list,perPage:ze,headers:g.value,ref_key:"table",ref:C},{"item-name":a(l=>[N("p",Pe,d(l.userFirstName)+" "+d(l.userLastName),1)]),"item-createdAt":a(l=>[_(d(e(Y)(l.createdAt).format("HH:mm D MMMM")),1)]),"item-valueCents":a(l=>[_(d(l.valueCents/100)+" "+d(e(k)),1)]),"item-status":a(l=>[t($e,{color:e(w)(l.status)},{default:a(()=>[_(d(e(V)(l.status)),1)]),_:2},1032,["color"])]),"item-actions":a(l=>[N("a",{href:l.payoutLink},[e(n).user.type==="Client"?(b(),$(P,{key:0,text:e(s)("billing.pay")},{activator:a(({props:A})=>[t(y,L(A,{variant:"tonal",color:"primary",icon:"",flat:""}),{default:a(()=>[t(fe,{size:"20",class:"text-primary","stroke-width":"1.5"})]),_:2},1040)]),_:1},8,["text"])):B("",!0)],8,We),e(n).user.type==="Therapist"&&l.status==="READY"?(b(),$(P,{key:0,text:e(s)("edit")},{activator:a(({props:A})=>[t(y,L({onClick:be=>ue(l)},A,{color:"info",class:"tw-mr-2",variant:"tonal",icon:"",flat:""}),{default:a(()=>[t(ve,{size:"20",class:"text-info","stroke-width":"1.5"})]),_:2},1040,["onClick"])]),_:2},1032,["text"])):B("",!0),e(n).user.type==="Therapist"&&l.status==="READY"?(b(),$(P,{key:1,text:e(s)("delete")},{activator:a(({props:A})=>[t(y,L({onClick:be=>de(l)},A,{color:"error",variant:"tonal",icon:"",flat:""}),{default:a(()=>[t(ge,{size:"20",class:"text-error","stroke-width":"1.5"})]),_:2},1040,["onClick"])]),_:2},1032,["text"])):B("",!0)]),_:1},8,["onUpdate","page","filters","total","items","headers"])]),_:1})]),_:1},8,["isUpdate"]),t(Ce,{onDelete:pe,modelValue:E.value,"onUpdate:modelValue":p[4]||(p[4]=l=>E.value=l),title:e(s)("billing.deleteNote"),loading:M.value,question:e(s)("billing.deleteQuestion")},null,8,["modelValue","title","loading","question"]),t(Fe,{onUpdate:ce,price:h.value,"onUpdate:price":p[5]||(p[5]=l=>h.value=l),dialog:D.value,"onUpdate:dialog":p[6]||(p[6]=l=>D.value=l),loading:v.value},null,8,["price","dialog","loading"])],64)}}});export{lt as default};
